---
title: 运行环境
index_img: 'https://gitee.com/ylea/imagehost/raw/master/index_img/v8.jpg'
banner_img: 'https://gitee.com/ylea/imagehost/raw/master/banner_img/2.jpg'
date: 2020-12-20 11:39:07
categories:
    - 前端面试题
tags:
    - V8
---



# V8 执行 JS 大致流程

&emsp;&emsp;编程语言有两种类别：静态类型和动态类型。

&emsp;&emsp;**静态类型语言**如 C++、GO 等，需要提前编译（AOT）成机器码然后执行，这个过程主要使用**编译器**来完成。

&emsp;&emsp;**动态类型语言**如 JS、Python 等，只在运行时进行编译执行（JIT），这个过程通过**解释器**来完成。



&emsp;&emsp;而 V8 采用了混合编译执行和解释执行的方式，我们称为 **JIT**（Just-In-Time-Compilation）

&emsp;&emsp;这是一种权衡策略，因为这两种方法都有各自优缺点，解释执行的启动速度快，但是执行时的速度慢，而编译执行的启动速度慢，但是执行时的速度快。

## 编译器的工作流程

源代码	`->`	词法分析、语法分析	`->`	AST	`->`	语义分析	`->`	中间代码	`->`	代码优化	`->`	机器码	`->`	执行

## 解释器工作流程

源代码	`->`	词法、语法分析	`->`	AST	`->`	语义分析	`->`	字节码	`->`	执行

## V8 工作流程

&emsp;&emsp;首先将 JS **源码**通过解析器解析成**抽象语法树 AST**。

<img src="https://gitee.com/ylea/imagehost/raw/master/img/image-20200802170037793.png" alt="image-20200802170037793" style="zoom:80%;" />

&emsp;&emsp;接着再通过解释器将 **AST** 编译成**字节码** bytecode

&emsp;&emsp;字节码是跨平台的一种中间表示，不同于最终的机器代码，字节码与平台无关，能够在不同操作系统上运行：

<img src="https://gitee.com/ylea/imagehost/raw/master/img/image-20200802170115022.png" alt="image-20200802170115022" style="zoom:80%;" />

&emsp;&emsp;字节码最后通过编译器生成机器代码：

<img src="https://gitee.com/ylea/imagehost/raw/master/img/image-20200802170225783.png" alt="image-20200802170225783" style="zoom:80%;" />

### 基础准备

&emsp;&emsp;V8 在启动执行 JS 之前，还需要准备一些执行 JS 需要的基础环境，包括 **堆空间**，**栈空间**，**全局执行上下文**，**全局作用域**，**消息循环系统**，**内置函数** 等。

## 执行步骤

&emsp;&emsp;基础环境准备好之后，接下来就能使用 V8 执行启动 JS 了：

1. 首先使用解析器将 JS 源码解析成抽象语法树（AST），它是一种便于 V8 理解的结构，在生成 AST 的同时，V8 还会生成相关的作用域，作用域中存放相关变量。
2. 接着，通过解释器将 AST 编译成字节码 bytecode，解释器可以直接执行字节码，或通过编译器将其编译为二进制代码再执行
3. 解释器按照顺序解释执行字节码，并输出执行结果
4. 在解释器执行过程中，若某段代码被重复多次执行，那么这段代码会被标记为热点代码
5. 对于热点代码，V8 会将这段字节码交给编译器去将其编译为二进制代码，并执行优化操作，优化后的二进制代码执行效率会大幅提升。若下面再次执行到这段代码时，V8 会优先选择执行优化后的二进制代码。
6. 不过，由于 JS 是一种动态类型语言，因此在执行过程中某个对象的结构和属性是可以被修改的，而经过编译器优化后的代码是只针对某种固定的结构，因此编译器需要再次执行优化操作。



## 小结

&emsp;&emsp;V8 执行一段 JS 代码的大致流程：

1. 初始化基础环境
2. 解析源码生成 AST 和作用域
3. 根据 AST 和作用域生成字节码
4. 解释执行字节码
5. 监听热点代码
6. 使用编译器优化编译热点代码成二进制代码



























































